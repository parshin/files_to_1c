
Функция UploadFilePost(Запрос)
	
	Ответ = Новый HTTPСервисОтвет(200);
	Ответ.Заголовки.Вставить("Content-type", "application/json;  charset=utf-8");
	
	Результат = Новый Структура;
	Результат.Вставить("result", Ложь);
	Результат.Вставить("description", "");
	
	ТелоОтвета = Запрос.ПолучитьТелоКакСтроку();
	Если ЗначениеЗаполнено(ТелоОтвета) Тогда
		ОбъектJSON = ПреобразоватьВСтрокуИзJSON(ТелоОтвета);
		Если ОбъектJSON <> Неопределено Тогда
			Штрихкод = ОбъектJSON.barcode;
			Если ОбъектJSON.Свойство("doc_type") Тогда
				
				ДвоичныеДанныеФайла = Base64Значение(ОбъектJSON.file);
				ВремяИзмененияУниверсальное = Неопределено;
				АдресВремХранилище = ПоместитьВоВременноеХранилище(ДвоичныеДанныеФайла, Новый УникальныйИдентификатор);
				
				МассивДокументов = ШтрихкодированиеПечатныхФорм.ПолучитьСсылкуПоШтрихкодуТабличногоДокумента(Штрихкод);
				Если МассивДокументов.Количество() = 0 Тогда 
					Результат.Вставить("description", "Не найден документ по штрихкоду: " + Штрихкод + " (" + ОбъектJSON.file_name + ")");
				КонецЕсли;
				
				Для Каждого ДокументСсылка Из МассивДокументов Цикл

					НаименованиеФайла = "КОМПЛЕКТ ДОКУМЕНТОВ";
					РасширениеБезТочки = "jpg";
						
					ПрисоединенныйФайл = ПрисоединенныеФайлыСлужебныйВызовСервера.ДобавитьФайл(
						ДокументСсылка,
						ОбъектJSON.file_name,
						РасширениеБезТочки,
						,
						ВремяИзмененияУниверсальное,
						АдресВремХранилище,
						"",
						СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("%1 № %2 от %3. Создан автоматически.",
							НаименованиеФайла,
							ДокументСсылка.Номер,
							ДокументСсылка.Дата)
					);
						
						Результат.Вставить("result", Истина);
						Результат.Вставить("description", "Файл " + ОбъектJSON.file_name + " прикреплен к " + Строка(ДокументСсылка));

				КонецЦикла;
				
			Иначе
				// ДРУГИЕ ТИПЫ ДОКУМЕНТОВ
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, Результат);
	СтрокаДляОтвета = ЗаписьJSON.Закрыть();		
	Ответ.УстановитьТелоИзСтроки(СтрокаДляОтвета, КодировкаТекста.UTF8, ИспользованиеByteOrderMark.НеИспользовать);
	
	Возврат Ответ;
	
КонецФункции

// Получение данных из строки в формате JSON.
Функция ПреобразоватьВСтрокуИзJSON(Строка)
	
	Результат = Неопределено;
	
	ЧтениеJSON = Новый ЧтениеJSON;
	Попытка
		ЧтениеJSON.УстановитьСтроку(Строка);
		Результат = ПрочитатьJSON(ЧтениеJSON);
		ЧтениеJSON.Закрыть();
	Исключение
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции
